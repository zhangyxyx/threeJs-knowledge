<!DOCTYPE html>
<html>

<head>
    <title>bar test World Population Visualization</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.6/build/dat.gui.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks/dist/maptalks.css">
    <script type="text/javascript" src="./lib/maptalks.js"></script>
    <script type="text/javascript" src="./build/three.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/maptalks.three@latest/dist/maptalks.three.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.6/build/dat.gui.min.js"></script>

    
    <script type="text/javascript" src="./js/shaders/LuminosityHighPassShader.js"></script>
    <script type="text/javascript" src="./js/postprocessing/EffectComposer.js"></script>
    <script type="text/javascript" src="./js/postprocessing/UnrealBloomPass.js"></script>
    <script type="text/javascript" src="./js/postprocessing/RenderPass.js"></script>
    <script type="text/javascript" src="./js/shaders/CopyShader.js"></script>
    <script type="text/javascript" src="./js/postprocessing/ShaderPass.js"></script>
    <script type="text/javascript" src="./js/loaders/OBJLoader.js"></script>
    <script type="text/javascript" src="./js/loaders/DDSLoader.js"></script>
    <script type="text/javascript" src="./js/loaders/MTLLoader.js"></script>
    <style>
        html,
        body {
            margin: 0px;
            height: 100%;
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #000;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        window.winscene
        window.wincamera
        window.renderer
        var map = new maptalks.Map("map", {
            center: [118.787,32.0276],
            zoom: 17.5,
            pitch: 69,
            bearing:0,
            centerCross: true,
            doubleClickZoom: false,
            baseLayer: new maptalks.TileLayer('tile', {
                urlTemplate: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
                subdomains: ['a','b','c','d'],
                attribution: '',
                cssFilter : 'sepia(100%) invert(90%)',
            }),
        });
        var threeLayer = new maptalks.ThreeLayer('t', {
            forceRenderOnMoving: true,
            forceRenderOnRotating: true
        });
        threeLayer.prepareToDraw = function (gl, scene, camera) {
            winscene=this.getScene()
            wincamera=this.getCamera()
            renderer=this.getThreeRenderer();
            const light = new THREE.AmbientLight(0xffffff, 0.6);
            light.layers.enable(0);
            light.layers.enable(1);
            winscene.add(light);
            winscene.add(light);
            setTimeout(() => {
                initComposer();
                //main();
                render();
               
            }, 1000);

        };
        threeLayer.addTo(map);
        console.log(threeLayer)
        function initComposer(){
            const params = {
                exposure: 0,
                bloomStrength: 1.5,
                bloomThreshold: 0,
                bloomRadius: 0,
            };
            composer = new THREE.EffectComposer(renderer);
            const size = threeLayer.getMap().getSize();
            composer.setSize(size.width, size.height);
            const renderScene = new THREE.RenderPass(winscene, wincamera);
            // 光晕
            const bloomPass = new THREE.UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight),
            1.5,
            0.4,
            0.85
            );
            bloomPass.threshold = params.bloomThreshold;
            bloomPass.strength = params.bloomStrength;
            bloomPass.radius = params.bloomRadius;
            composer.addPass(renderScene);
            composer.addPass(bloomPass);
        };
        function render(){
            renderer.autoClear = false;
            renderer.clear();
            wincamera.layers.set(1);
            composer.render();
            renderer.clearDepth(); // 清除深度缓存
            wincamera.layers.set(0);
            renderer.render(winscene, wincamera);
            requestAnimationFrame(render);
        };
        function main(){
            var url='./model/'
            var mtlLoader2 = new THREE.MTLLoader();
            mtlLoader2.load( url+'mesh.mtl', function( materials ) {
                var objLoader = new THREE.OBJLoader();
                objLoader.setMaterials( materials );
                objLoader.load( url+'mesh.obj', function ( object ) {
                    object.traverse( function ( child ) {
                        if ( child.type==='Mesh' ) { 
                            child.layers.set(1);
                            child.scale.set(0.01, 0.01, 0.01);
                            child.rotation.set(Math.PI * 1 / 2, -0.3,0);
                        }
                        if ( child.type==='Group' ) {
                        }
                    });
                    var model=threeLayer.toModel(object,{
                        coordinate:[118.786500,32.02697],
                        altitude:0
                    });
                    
                    threeLayer.addMesh(model);
                });
            });
        }


    </script>
</body>

</html>